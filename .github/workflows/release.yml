name: Release
on:
  push:
    branches:
      - main
permissions:
  contents: write
jobs:
  bump-version-and-release:
    name: Bump Version & Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Bump version and create tag
        id: version
        run: |
          VERSION=$(date +'%Y.%m.%d-%H%M%S')
          sed -i "s/\"version\": [0-9]\+/\"version\": $VERSION/" metadata.json
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add metadata.json
          git commit -m "Bump version to $VERSION"
          git tag $VERSION
          git push origin main --tags
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      - name: Extract the changelog
        id: changelog
        run: |
          TAG_NAME=${{ steps.version.outputs.version }}
          READ_SECTION=false
          CHANGELOG=""
          while IFS= read -r line; do
            if [[ "$line" =~ ^#+\ +(.*) ]]; then
              if [[ "${BASH_REMATCH[1]}" == "$TAG_NAME" ]]; then
                READ_SECTION=true
              elif [[ "$READ_SECTION" == true ]]; then
                break
              fi
            elif [[ "$READ_SECTION" == true ]]; then
              CHANGELOG+="$line"$'\n'
            fi
          done < "CHANGELOG.md"
          CHANGELOG=$(echo "$CHANGELOG" | awk '/./ {$1=$1;print}')
          echo "changelog_content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Create the release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ steps.version.outputs.version }}
          body: '${{ steps.changelog.outputs.changelog_content }}'
          draft: false
          prerelease: false
